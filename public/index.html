<!DOCTYPE html>
<html>
<head>
  <title>ü§ñ Dignity Shop Chatbot Panel</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; }
    h1,h2 { color: #333; }
    #rules, #buttons, #conversations { margin-bottom: 20px; }
    input, button { padding: 6px; margin: 5px 0; }
    .rule, .button-rule { display: flex; gap: 10px; margin-bottom: 5px; }
    .conv { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #fff; }
    .user { color: blue; }
    .bot { color: green; }
  </style>
</head>
<body>
  <h1>ü§ñ Chatbot Control Panel</h1>

  <h2>Text Rules</h2>
  <div id="rules"></div>
  <button onclick="addTextRule()">‚ûï Add Text Rule</button>

  <h2>Interactive Button Rules</h2>
  <div id="buttons"></div>
  <button onclick="addButtonRule()">‚ûï Add Button Rule</button>

  <button onclick="saveRules()">üíæ Save All Rules</button>

  <h2>Conversation History</h2>
  <div id="conversations"></div>

  <script>
    let rulesData = {};

    // Load rules.json
    async function loadRules() {
      const res = await fetch('/rules.json');
      rulesData = await res.json();
      renderTextRules();
      renderButtonRules();
    }

    // Render Text Rules
    function renderTextRules() {
      const container = document.getElementById('rules');
      container.innerHTML = '';
      for (let key in rulesData) {
        if (key === 'buttons') continue; // skip button section
        const value = rulesData[key].text || rulesData[key];
        const div = document.createElement('div');
        div.className = 'rule';
        div.innerHTML = `
          <input value="${key}" onchange="changeTextKey(this, '${key}')"/>
          <input value="${value}" onchange="changeTextValue(this, '${key}')"/>
          <button onclick="deleteTextRule('${key}')">üóëÔ∏è</button>
        `;
        container.appendChild(div);
      }
    }

    function changeTextKey(input, oldKey) {
      const value = rulesData[oldKey];
      delete rulesData[oldKey];
      rulesData[input.value] = value;
      renderTextRules();
    }

    function changeTextValue(input, key) {
      if (typeof rulesData[key] === 'object') rulesData[key].text = input.value;
      else rulesData[key] = input.value;
    }

    function deleteTextRule(key) {
      delete rulesData[key];
      renderTextRules();
    }

    function addTextRule() {
      rulesData['new_rule'] = 'new reply';
      renderTextRules();
    }

    // Render Button Rules
    function renderButtonRules() {
      const container = document.getElementById('buttons');
      container.innerHTML = '';
      if (!rulesData.buttons) rulesData.buttons = {};

      for (let id in rulesData.buttons) {
        const value = rulesData.buttons[id];
        const div = document.createElement('div');
        div.className = 'button-rule';
        div.innerHTML = `
          <input value="${id}" onchange="changeButtonId(this, '${id}')"/>
          <input value="${value}" onchange="changeButtonValue(this, '${id}')"/>
          <button onclick="deleteButtonRule('${id}')">üóëÔ∏è</button>
        `;
        container.appendChild(div);
      }
    }

    function changeButtonId(input, oldId) {
      const value = rulesData.buttons[oldId];
      delete rulesData.buttons[oldId];
      rulesData.buttons[input.value] = value;
      renderButtonRules();
    }

    function changeButtonValue(input, id) {
      rulesData.buttons[id] = input.value;
    }

    function deleteButtonRule(id) {
      delete rulesData.buttons[id];
      renderButtonRules();
    }

    function addButtonRule() {
      rulesData.buttons['new_button'] = 'reply text';
      renderButtonRules();
    }

    // Save all rules
    async function saveRules() {
      await fetch('/update-rules', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(rulesData)
      });
      alert('‚úÖ Rules saved!');
      loadRules();
    }

    // Load conversation history
    async function loadConversations() {
      const res = await fetch('/conversations');
      const data = await res.json();
      const container = document.getElementById('conversations');
      container.innerHTML = '';
      for (let user in data) {
        const div = document.createElement('div');
        div.className = 'conv';
        div.innerHTML = `<strong>User ${user}</strong><br>`;
        data[user].forEach(msg => {
          const span = document.createElement('div');
          span.className = msg.from;
          span.textContent = `${msg.from.toUpperCase()}: ${msg.text}`;
          div.appendChild(span);
        });
        container.appendChild(div);
      }
    }

    setInterval(loadConversations, 3000); // refresh every 3s

    loadRules();
    loadConversations();
  </script>
</body>
</html>
